// Crate icon overrides //

/obj/structure/closet/crate // Pulls all crate icons from the Pentest dmi
	icon = 'modular_pentest/master_files/icons/obj/crates.dmi'

/obj/structure/closet/crate/goldcrate // This is the Shiptest crate full of gold stuff
	icon_state = "gold"

/obj/structure/closet/crate/silvercrate // and the Shiptest crate full of silver stuff
	icon_state = "silver"

// Pentest original crates //

/obj/structure/closet/crate/gold
	name = "gold crate"
	desc = "A shiny, gold-colored crate."
	icon_state = "gold"

/obj/structure/closet/crate/diamond
	name = "diamond crate"
	desc = "A diamond crate. Well, it's not actually diamond, but it looks nice."
	icon_state = "diamond"

/obj/structure/closet/crate/pink
	name = "pink crate"
	desc = "A glittery pink crate."
	icon_state = "pink"

/obj/structure/closet/crate/lavender
	name = "lavender crate"
	desc = "A glittery purple... wait, no, lavender crate."
	icon_state = "lavender"

/obj/structure/closet/crate/emerald
	name = "emerald crate"
	desc = "A glittery emerald crate."
	icon_state = "emerald"

// Abandoned Clown Crate (also a Pentest original) (wow thank you OnlineGirlfriend) //

/obj/structure/closet/crate/secure/loot/clown // Keep those clowns locked up
	name = "abandoned clown crate"
	desc = "You hear faint laughter from within..."
	icon = 'modular_pentest/master_files/icons/obj/crates.dmi'
	icon_state = "clown"
	codelen = 4
	attempts = 10
	qdel_on_open = FALSE
	spawned_loot = FALSE
	tamperproof = 90

/obj/structure/closet/crate/secure/loot/clown/Initialize()
	. = ..()
	if(locked)
		lock()

/obj/structure/closet/crate/secure/loot/clown/lock()
	cut_overlays()
	add_overlay(image('icons/obj/closets.dmi', "securecrater")) // pulls from the shiptest for the lock overlay

/obj/structure/closet/crate/secure/loot/clown/unlock()
	cut_overlays()
	add_overlay(image('icons/obj/closets.dmi', "securecrateg"))

/obj/structure/closet/crate/secure/loot/clown/attack_hand(mob/user)
	if(locked)
		to_chat(user, span_notice("The crate is locked with a Deca-code lock."))
		var/input = input(usr, "Enter [codelen] digits. All digits must be unique.", "Deca-Code Lock", "") as text|null
		if(user.canUseTopic(src, BE_CLOSE))
			var/list/sanitised = list()
			var/sanitycheck = TRUE
			var/char = ""
			var/length_input = length(input)
			for(var/i = 1, i <= length_input, i += length(char))
				char = input[i]
				sanitised += text2num(char)
			for(var/i = 1, i <= length(sanitised) - 1, i++)
				for(var/j = i + 1, j <= length(sanitised), j++)
					if(sanitised[i] == sanitised[j])
						sanitycheck = FALSE
			if(input == code)
				to_chat(user, span_notice("The crate unlocks with a honk!"))
				locked = FALSE
				unlock()
				tamperproof = 0
				if(!spawned_loot)
					spawn_loot()
			else if(!input || !sanitycheck || length(sanitised) != codelen)
				to_chat(user, span_notice("You leave the funny crate alone."))
				lock()
			else
				to_chat(user, span_warning("A red light flashes."))
				lastattempt = input
				attempts--
				lock()
				if(attempts == 0)
					boom(user)
	else
		return ..()

/obj/structure/closet/crate/secure/loot/clown/spawn_loot()
	var/loot = rand(1, 20)
	switch(loot)
		if(1 to 3) // Clown in space
			new /obj/item/clothing/suit/space/hardsuit/clown(src)
			new /obj/item/clothing/head/helmet/space/hardsuit/clown(src)
		if(4 to 6) // Squeak
			new /obj/item/clothing/mask/gas/clown_hat(src)
			new /obj/item/clothing/shoes/clown_shoes/banana_shoes(src)
			new /obj/item/stack/sheet/mineral/hidden/hellstone/fifty(src)
			new /obj/item/stack/sheet/mineral/hidden/hellstone/fifty(src)
		if(7 to 9) // Tradclown starter pack
			new /obj/item/storage/backpack/ert/clown(src)
			new /obj/item/pneumatic_cannon/pie/selfcharge(src)
			new /obj/item/bikehorn/golden(src)
			new /obj/item/reagent_containers/food/drinks/soda_cans/canned_laughter(src)
			new /obj/item/megaphone/clown(src)
		if(10) // Rare sexy clown drop
			new /obj/item/clothing/mask/gas/sexyclown(src)
			new /obj/item/clothing/under/rank/civilian/clown/sexy(src)
			new /obj/item/toy/crayon/spraycan/lubecan(src)
			new /obj/item/reagent_containers/food/snacks/chewable/lollipop(src)
		if(11 to 12) // Two jester outfits, for when you wanna match with bae
			new /obj/item/clothing/under/rank/civilian/clown/jester(src)
			new /obj/item/clothing/under/rank/civilian/clown/jester/alt(src)
			new /obj/item/clothing/head/jester(src)
			new /obj/item/clothing/head/jester/alt(src)
			new /obj/item/clothing/shoes/clown_shoes/jester(src)
			new /obj/item/clothing/shoes/clown_shoes/jester(src)
			new /obj/item/reagent_containers/food/drinks/bottle/grenadine(src) // Jester grenadine, idk seemed funny
		if(13 to 14) // OTP <3
			new /obj/item/clothing/suit/hooded/hoodie/orange(src)
			new /obj/item/clothing/suit/hooded/hoodie/blackwa(src)
			new /obj/item/bedsheet/double/clown(src)
			new /obj/item/bedsheet/double/mime(src)
			new /obj/item/toy/figure/clown(src)
			new /obj/item/toy/figure/mime(src)
			new /obj/item/stamp/clown(src)
			new /obj/item/stamp/mime(src)
			new /obj/item/food/cake/clown_cake(src)
			new /obj/item/reagent_containers/food/snacks/pie/mimetart(src)
		if(15 to 16) // Mime crate
			new /obj/item/storage/backpack/mime(src)
			new /obj/item/clothing/mask/gas/mime(src)
			new /obj/item/clothing/under/rank/civilian/mime(src)
			new /obj/item/clothing/under/rank/civilian/mime/skirt(src)
			new /obj/item/clothing/head/beret(src)
			new /obj/item/clothing/suit/toggle/suspenders(src)
			new /obj/item/toy/crayon/spraycan/mimecan(src)
		if(17) // Sexy mime...
			new /obj/item/clothing/under/rank/civilian/mime/sexy(src)
			new /obj/item/clothing/mask/gas/sexymime(src)
			new /obj/item/toy/crayon/spraycan/lubecan(src)
			new /obj/item/reagent_containers/food/snacks/chewable/lollipop(src)
		if(18) // Bananium shield
			new /obj/item/shield/energy/bananium(src)
		if(19) // Bananium sword
			new /obj/item/melee/energy/sword/bananium(src)
		if(20) // Honestly worth it
			new /obj/item/soap/omega(src)
			new /obj/item/soap/omega(src)
			new /obj/item/soap/omega(src)
			new /obj/item/soap/omega(src)

	spawned_loot = TRUE
