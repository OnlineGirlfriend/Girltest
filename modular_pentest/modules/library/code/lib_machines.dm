// Book binder override //

/obj/machinery/bookbinder
	desc = "A top-of-the-line bookbinder. You could insert books or paper into this."
	var/obj/item/book/current_book
	var/list/cover_icon_states = list(
		"elegant_green",
		"elegant_red",
		"elegant_black",
		"elegant_white",
		"elegant_blue",
		"pastel_yellow",
		"pastel_green",
		"pastel_blue",
		"pastel_orange",
		"pastel_purple",
		"pastel_pink"
	)

	var/list/cover_friendly_names = list(
		"elegant_green" = "Elegant Green",
		"elegant_red" = "Elegant Red",
		"elegant_black" = "Elegant Black",
		"elegant_white" = "Elegant White",
		"elegant_blue" = "Elegant Blue",
		"pastel_yellow" = "Yellow Heart",
		"pastel_green" = "Green Heart",
		"pastel_blue" = "Blue Heart",
		"pastel_orange" = "Orange Heart",
		"pastel_purple" = "Purple Moth",
		"pastel_pink" = "Pink Cat"
		)

/obj/machinery/bookbinder/Initialize()
	. = ..()
	current_book = null
	mouse_opacity = 1

/obj/machinery/bookbinder/attackby(obj/item/I, mob/user, params)
	if(istype(I, /obj/item/book))
		var/obj/item/book/B = I

		if(B.unique)
			to_chat(user, "You can't change the cover of this book.")
			return

		if(current_book)
			to_chat(user, "There's already a book inside.")
			return

		B.forceMove(src)
		current_book = B
		to_chat(user, "You insert the book into the bookbinder.")
		src.reskin(user)
		return

	. = ..()

/obj/machinery/bookbinder/attack_hand(mob/user)
	if(current_book)
		to_chat(user, "You remove the [current_book.name] from the bookbinder.")
		current_book.forceMove(get_turf(src))
		current_book = null
	else
		. = ..()

/obj/machinery/bookbinder/proc/reskin(mob/user) // Lets you select a cover
	if(!current_book || !user)
		return

	var/html = "<h3>Choose a new book cover</h3><table style='width:100%'>"
	for(var/state in cover_icon_states)
		var/nicename = cover_friendly_names[state] || state
		var/icon/I = icon('modular_pentest/modules/library/icons/library.dmi', state)
		html += "<tr><td>[icon2html(I, user)]</td><td><a href='?src=[REF(src)];set_cover=[state]'>[nicename]</a></td></tr>"
	html += "</table>"
	var/datum/browser/popup = new(user, "bookcoverselect", "Book Cover Selection", 350, 400)
	popup.set_content(html)
	popup.open()

/obj/machinery/bookbinder/Topic(href, href_list)
	if(href_list["set_cover"])
		var/choice = href_list["set_cover"]
		if(choice in cover_icon_states && current_book && !QDELETED(current_book))
			current_book.icon = 'modular_pentest/modules/library/icons/library.dmi'
			current_book.icon_state = choice
			to_chat(usr, "You set the book's cover to '[cover_friendly_names[choice] || choice]'.")
			add_fingerprint(usr)
		return
	return ..()

/obj/machinery/bookbinder/AltClick(mob/user)
	if(current_book)
		reskin(user)
		return TRUE
	return ..()
