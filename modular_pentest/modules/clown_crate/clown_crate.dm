// Abandoned Clown Crate //

// A clown-themed subset of the abandoned crate.

/obj/structure/closet/crate/secure/loot/clown
	name = "abandoned clown crate"
	desc = "You hear faint honking from within..."
	icon = 'modular_pentest/master_files/icons/obj/crates.dmi'
	icon_state = "clown_secure"
	codelen = 4
	attempts = 10
	qdel_on_open = FALSE
	spawned_loot = FALSE
	tamperproof = 90

/obj/structure/closet/crate/secure/loot/clown/Initialize()
	. = ..()
	if(locked)
		lock()

/obj/structure/closet/crate/secure/loot/clown/lock()
	cut_overlays()
	add_overlay(image('icons/obj/closets.dmi', "securecrater"))

/obj/structure/closet/crate/secure/loot/clown/unlock()
	cut_overlays()
	add_overlay(image('icons/obj/closets.dmi', "securecrateg"))

/obj/structure/closet/crate/secure/loot/clown/attack_hand(mob/user)
	if(locked)
		to_chat(user, span_notice("The crate is locked with a Deca-code lock."))
		var/input = input(usr, "Enter [codelen] digits. All digits must be unique.", "Deca-Code Lock", "") as text|null
		if(user.canUseTopic(src, BE_CLOSE))
			var/list/sanitised = list()
			var/sanitycheck = TRUE
			var/char = ""
			var/length_input = length(input)
			for(var/i = 1, i <= length_input, i += length(char))
				char = input[i]
				sanitised += text2num(char)
			for(var/i = 1, i <= length(sanitised) - 1, i++)
				for(var/j = i + 1, j <= length(sanitised), j++)
					if(sanitised[i] == sanitised[j])
						sanitycheck = FALSE
			if(input == code)
				to_chat(user, span_notice("The crate unlocks!"))
				locked = FALSE
				unlock()
				tamperproof = 0
				if(!spawned_loot)
					spawn_loot()
			else if(!input || !sanitycheck || length(sanitised) != codelen)
				to_chat(user, span_notice("You leave the crate alone."))
				lock()
			else
				to_chat(user, span_warning("A red light flashes."))
				lastattempt = input
				attempts--
				lock()
				if(attempts == 0)
					boom(user)
	else
		return ..()

/obj/structure/closet/crate/secure/loot/clown/spawn_loot()
	var/loot = rand(1, 20)
	switch(loot)
		if(1 to 3)
			new /obj/item/clothing/suit/space/hardsuit/clown(src)
			new /obj/item/clothing/head/helmet/space/hardsuit/clown(src)
		if(4 to 5)
			new /obj/item/clothing/shoes/clown_shoes/banana_shoes(src)
			// add hellstone to power it
		if(6 to 7)
			new /obj/item/pneumatic_cannon/pie/selfcharge(src)
		if(8 to 9)
			// something
		if(10)
			new /obj/item/clothing/under/rank/civilian/clown/jester(src)
			// other jester stuff?
		if(11 to 13)
			new /obj/item/toy/figure/clown(src)
			// add something here
		if(14 to 15)
			// uhh
		if(16 to 17)
			// idk
		if(18)
			new /obj/item/shield/energy/bananium(src)
		if(19)
			new /obj/item/melee/energy/sword/bananium(src)
		if(20)
			// Mime stuff?
	spawned_loot = TRUE
